{% extends "core/body.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<main class="main">

  {% if receipt_salts %}
  <div class="accordion my-4" id="receiptAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingReceipts">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseReceipts" aria-expanded="true" aria-controls="collapseReceipts">
          🔐 Απόδειξη Ψήφου (Receipt Hash + Salt)
        </button>
      </h2>
      <div id="collapseReceipts" class="accordion-collapse collapse show" aria-labelledby="headingReceipts" data-bs-parent="#receiptAccordion">
        <div class="accordion-body">
          <p>
            Μετά την ψήφο σας, το σύστημα δημιούργησε έναν <strong>μοναδικό κωδικό απόδειξης (receipt hash)</strong>, που αποδεικνύει ότι η ψήφος σας έχει καταγραφεί με ασφάλεια.<br>
            Παράλληλα, εμφανίζεται και ένα <strong>συμπληρωματικό στοιχείο (salt)</strong>, το οποίο βοηθά στην ενίσχυση της ασφάλειας.
          </p>

          <button class="btn btn-link p-0 mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#moreInfo" aria-expanded="false" aria-controls="moreInfo">
            📘 Διαβάστε περισσότερα για τη λειτουργία τους
          </button>

          <div class="collapse" id="moreInfo">
            <div class="card card-body bg-light border-0">
              <p><strong>🔐 Τι είναι το Hash:</strong> Είναι ένας μοναδικός, μη αναστρέψιμος κωδικός που δημιουργείται από την ψήφο σας. Μοιάζει με "ψηφιακό αποτύπωμα". Χρησιμοποιείται για να μπορείτε να επαληθεύσετε ότι η ψήφος σας υπάρχει χωρίς να αποκαλύπτεται το περιεχόμενό της.</p>
              <p><strong>🧂 Τι είναι το Salt:</strong> Είναι ένα επιπλέον τυχαίο δεδομένο που συνδυάζεται με την ψήφο πριν δημιουργηθεί το hash, ώστε ακόμα και ίδιες ψήφοι να έχουν διαφορετικά hashes. Προστατεύει από επιθέσεις συσχέτισης.</p>
              <p><strong>✅ Πώς γίνεται η επαλήθευση:</strong> Αρκεί να εισαγάγετε μόνο τον κωδικό hash στη σελίδα <a href="{% url 'verify_receipt' election.id %}">"Έλεγχος της ψήφου μου"</a>. Το salt χρησιμοποιείται μόνο εσωτερικά για επαλήθευση από το σύστημα.</p>
            </div>
          </div>

          <ul class="list-group mt-3">
            {% for hash, salt in receipt_salts %}
              <li class="list-group-item">
                <strong>Hash:</strong> <code>{{ hash }}</code>
                <span data-bs-toggle="tooltip" title="Ο κωδικός hash είναι η απόδειξη της ψήφου σας.">ℹ️</span><br>
                <strong>Salt:</strong> <code>{{ salt }}</code>
                <button class="btn btn-sm btn-outline-secondary float-end mt-2 copy-btn" data-hash="{{ hash }}" data-salt="{{ salt }}">
                  Αντιγραφή
                </button>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Page title -->
  <div class="page-title dark-background" data-aos="fade"
       style="background-image:url({% static 'core/assets/img/blog-page-title-bg.jpg' %});">
    <div class="container">
      <h1>Αποτελέσματα Εκλογών</h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a href="{% url 'home' %}">Αρχική</a></li>
          <li class="current">Αποτελέσματα</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="container my-4">

    <!-- Turnout summary -->
    <section class="mb-5">
      <div class="card shadow-sm p-4">
        <h2 class="text-primary mb-3">📊 Συμμετοχή Ψηφοφόρων</h2>
        <p><strong>{{ turnout_text.label_1 }}:</strong> {{ total_voters }}</p>
        <p><strong>{{ turnout_text.label_2 }}:</strong> {{ turnout_text.voters_voted }}</p>
        <p><strong>{{ turnout_text.label_3 }}:</strong> {{ turnout_percentage }}%</p>
        <a href="{% url 'verify_receipt' election.id %}" class="btn btn-outline-secondary btn-sm mt-2">
          Έλεγχος της ψήφου μου
        </a>
      </div>
    </section>

    <!-- Results table -->
    <section class="mb-5">
      <div class="card shadow-sm p-4">
        <h2 class="text-primary mb-3">🗳️ Πίνακας Αποτελεσμάτων</h2>
        <table class="table table-striped mb-0">
          <thead><tr><th>Υποψήφιος</th><th>Ψήφοι</th><th>%</th></tr></thead>
          <tbody>
            {% for r in results %}
              <tr><td>{{ r.name }}</td><td>{{ r.votes }}</td><td>{{ r.percentage }}%</td></tr>
            {% empty %}<tr><td colspan="3">Δεν υπάρχουν ακόμα ψήφοι.</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Global charts -->
    <div class="row mb-5">
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm p-4 h-100">
          <h2 class="text-primary mb-3">📊 Ψήφοι ανά Υποψήφιο</h2>
          <canvas id="votesChart"></canvas>
        </div>
      </div>
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm p-4 h-100">
          <h2 class="text-primary mb-3">📈 Κατανομή Ψήφων</h2>
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Overall demographics -->
   {% if show_demographics %}
  <div class="row mb-5">
    {% if gender_labels_json|length > 2 %}
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm p-4 h-100">
          <h2 class="text-primary mb-3">👥 Ψήφοι ανά Φύλο (συνολικά)</h2>
          <canvas id="genderChart"></canvas>
        </div>
      </div>
    {% endif %}
    {% if age_labels_json|length > 2 %}
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm p-4 h-100">
          <h2 class="text-primary mb-3">📊 Ψήφοι ανά Ηλικιακή Ομάδα (συνολικά)</h2>
          <canvas id="ageChart"></canvas>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Ανάλυση ανά υποψήφιο -->
  <div class="row mb-5">
    <div class="col-12 mb-4">
      <div class="card shadow-sm p-4">
        <h2 class="text-primary mb-3">👤 Ανάλυση Φύλου ανά Υποψήφιο</h2>
        <canvas id="genderPerCandidateChart"></canvas>
      </div>
    </div>
    <div class="col-12 mb-4">
      <div class="card shadow-sm p-4">
        <h2 class="text-primary mb-3">📅 Ανάλυση Ηλικιών ανά Υποψήφιο</h2>
        <canvas id="agePerCandidateChart"></canvas>
      </div>
    </div>
  </div>
{% else %}
  <div class="alert alert-warning my-4" role="alert">
    <p>
      🔒 Για λόγους προστασίας της ανωνυμίας και αποφυγής στίγματος,
      τα δημογραφικά στατιστικά δεν εμφανίζονται όταν οι ψήφοι είναι λιγότερες από
      <strong>{{ demo_k_anon }}</strong>.
    </p>
  </div>
{% endif %}

  </div><!-- /.container -->
</main>

{# ---------- SAFE JSON blobs ---------- #}
{{ results_labels_json|json_script:"js-results-labels" }}
{{ results_votes_json|json_script:"js-results-votes" }}
{{ gender_labels_json|json_script:"js-gender-labels" }}
{{ gender_counts_json|json_script:"js-gender-counts" }}
{{ age_labels_json|json_script:"js-age-labels" }}
{{ age_counts_json|json_script:"js-age-counts" }}
{{ gender_per_candidate_json|json_script:"js-gender-per-cand" }}
{{ age_per_candidate_json|json_script:"js-age-per-cand" }}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const getJSON = id => JSON.parse(document.getElementById(id).textContent || '[]');
  const candLabels = getJSON('js-results-labels');
  const candVotes  = getJSON('js-results-votes');
  const gLabels    = getJSON('js-gender-labels');
  const gCounts    = getJSON('js-gender-counts');
  const aLabels    = getJSON('js-age-labels');
  const aCounts    = getJSON('js-age-counts');
  const genderData = getJSON('js-gender-per-cand');
  const ageData    = getJSON('js-age-per-cand');

  Chart.register(ChartDataLabels);

  new Chart(document.getElementById('votesChart'), {
    type: 'bar',
    data: { labels: candLabels, datasets: [{ label: 'Ψήφοι', data: candVotes }] },
    options: {
      indexAxis: 'y',
      plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'right' }},
      responsive: true,
    }
  });

  new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: { labels: candLabels, datasets: [{ data: candVotes }] },
    options: { plugins: { legend: { position: 'bottom' } }, responsive: true }
  });

  if (gLabels.length) {
    new Chart(document.getElementById('genderChart'), {
      type: 'pie',
      data: { labels: gLabels, datasets: [{ data: gCounts }] },
      options: { plugins: { legend: { position: 'bottom' } }, responsive: true }
    });
  }

  if (aLabels.length) {
    new Chart(document.getElementById('ageChart'), {
      type: 'bar',
      data: { labels: aLabels, datasets: [{ data: aCounts }] },
      options: {
        indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true } },
        responsive: true
      }
    });
  }

  const candidates = Object.keys(genderData);
  const genderCats = ['Male','Female','Prefer not to say','Unknown'];
  const ageCats = ['18-25','26-35','36-45','46-60','60+','Unknown'];

  const genderDatasets = genderCats.map(g => ({
    label: g,
    data: candidates.map(c => genderData[c]?.[g] || 0),
    stack: 'gender'
  }));

  const ageDatasets = ageCats.map(a => ({
    label: a,
    data: candidates.map(c => ageData[c]?.[a] || 0),
    stack: 'age'
  }));

  const stackedOpts = {
    responsive: true,
    plugins: { legend: { position: 'top' } },
    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
  };

  new Chart(document.getElementById('genderPerCandidateChart'), {
    type: 'bar',
    data: { labels: candidates, datasets: genderDatasets },
    options: stackedOpts
  });

  new Chart(document.getElementById('agePerCandidateChart'), {
    type: 'bar',
    data: { labels: candidates, datasets: ageDatasets },
    options: stackedOpts
  });

  // Tooltip ενεργοποίηση
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
});
</script>

<script>
document.querySelectorAll('.copy-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const hash = btn.getAttribute('data-hash');
    const salt = btn.getAttribute('data-salt');
    const text = `Hash: ${hash}\nSalt: ${salt}`;
    navigator.clipboard.writeText(text).then(() => {
      btn.innerText = '✅ Αντιγράφηκε!';
      setTimeout(() => { btn.innerText = 'Αντιγραφή'; }, 2000);
    });
  });
});
</script>
{% endblock %}
