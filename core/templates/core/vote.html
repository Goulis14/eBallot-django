{% extends "core/body.html" %}
{% load custom_filters %}
{% load static %}

{% block content %}
<main class="main">
  <!-- Τίτλος Σελίδας -->
  <div class="page-title dark-background" data-aos="fade" style="background-color: #2c3e50;">
    <div class="container">
      <h1 class="text-white">Ψηφοφορία</h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a href="{% url 'home' %}">Αρχική</a></li>
          <li class="current">Ψηφοφορία</li>
        </ol>
      </nav>
    </div>
  </div>
  <!-- Τέλος τίτλου -->

  <div class="container mt-5">
    <div class="row">
      <!-- Κύρια Στήλη -->
      <div class="col-lg-8">
        <section id="vote-section" class="vote section">
          <div class="container">

            <h2 class="title mb-3">{{ election.title }}</h2>
            <p class="mb-4">{{ election.description }}</p>

            <form method="POST" action="">
              {% csrf_token %}
              <p class="text-muted mb-2">
                Μπορείς να επιλέξεις έως {{ election.max_choices }} υποψηφίους.
              </p>

              <!-- Επιλογές Υποψηφίων -->
              <div class="form-group mb-3">
                {{ form.candidates }}
              </div>

              <button type="submit" class="btn btn-primary mt-3">
                Υποβολή Ψήφου
              </button>
            </form>

            <!-- Αποδείξεις Ψήφου (hash & salt) -->
            {% if user_votes %}
              <div class="mt-5">
                <h5 class="fw-bold mb-3">Οι αποδείξεις της ψήφου σου</h5>
                <p class="text-muted">Μπορείς να επαληθεύσεις τις ψήφους σου <a href="{% url 'verify_receipt' election.id %}">εδώ</a>.</p>

                <div class="accordion" id="receiptAccordion">
                  {% for vote in user_votes %}
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false"
                                aria-controls="collapse{{ forloop.counter }}">
                          Ψήφος {{ forloop.counter }} – Υποψήφιος: {{ vote.candidate.name }}
                        </button>
                      </h2>
                      <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse"
                           aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#receiptAccordion">
                        <div class="accordion-body">
                          <p><strong>Hash:</strong> <code>{{ vote.receipt_hash }}</code></p>
                          <p><strong>Salt:</strong> <code>{{ vote.salt }}</code></p>
                          <p class="text-muted small">Αποθήκευσε αυτά τα στοιχεία για να επαληθεύσεις τη ψήφο σου αργότερα.</p>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            {% if results %}
            <div class="mt-5">
              <h4>Αποτελέσματα:</h4>
              <ul>
                {% for candidate in election.candidates.all %}
                <li>
                  {{ candidate.name }} — {{ results|get_item:candidate.id|default:"0" }} ψήφοι
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
          </div>
        </section>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4 sidebar">
        <div class="widgets-container">
          <!-- Αναζήτηση -->
          <div class="search-widget widget-item">
            <h3 class="widget-title">Αναζήτηση</h3>
            <form method="GET" action="">
              <label>
                <input type="text" name="q" placeholder="Αναζήτηση ψηφοφοριών..." value="{{ query|default:'' }}" />
              </label>
              <button type="submit" title="Αναζήτηση"><i class="bi bi-search"></i></button>
            </form>
          </div>

          <!-- Κατηγορίες -->
          <div class="categories-widget widget-item">
            <h3 class="widget-title">Κατηγορίες</h3>
            <ul class="mt-3">
              {% for category in categories %}
              <li>
                <a href="{% url 'vote_category' category.slug %}">
                  {{ category.name }} <span>({{ category.vote_count }})</span>
                </a>
              </li>
              {% empty %}
              <li>Δεν βρέθηκαν κατηγορίες.</li>
              {% endfor %}
            </ul>
          </div>

          <!-- Πρόσφατες Ψηφοφορίες -->
          <div class="recent-posts-widget widget-item">
            <h3 class="widget-title">Πρόσφατες Ψηφοφορίες</h3>
            {% for recent_vote in recent_votes %}
            <div class="post-item">
              <div>
                <h4>
                  <a href="{% url 'vote_detail' recent_vote.id %}">
                    {{ recent_vote.title|truncatechars:50 }}
                  </a>
                </h4>
                <time datetime="{{ recent_vote.start_date|date:'Y-m-d' }}">
                  {{ recent_vote.start_date|date:"d/m/Y" }}
                </time>
              </div>
            </div>
            {% empty %}
            <p>Δεν υπάρχουν διαθέσιμες πρόσφατες ψηφοφορίες.</p>
            {% endfor %}
          </div>

          <!-- Tags -->
          <div class="tags-widget widget-item">
            <h3 class="widget-title">Ετικέτες</h3>
            <ul>
              {% for tag in tags %}
              <li><a href="{% url 'vote_tag' tag.slug %}">{{ tag.name }}</a></li>
              {% empty %}
              <li>Δεν υπάρχουν διαθέσιμες ετικέτες.</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      <!-- /sidebar -->
    </div>
  </div>
</main>
{% endblock %}
